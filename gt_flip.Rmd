---
title: "Creating Tables with `gt`"
author: "AECN 396/896-002"
output:
  xaringan::moon_reader:
    # css: [default, metropolis, metropolis-fonts] 
    css: xaringan-themer.css 
    lib_dir: libs
    nature:
      ratio: 16:9
      highlightStyle: github
      highlightLines: true
      countIncrementalSlides: false
---

```{r setup, include = FALSE}
options(htmltools.dir.version = FALSE)
```


```{r , include = FALSE}
library(knitr)
opts_chunk$set(
  fig.align = "center", 
  #fig.width=6, fig.height=4.5, 
  # out.width="748px", #out.length="520.75px",
  # dpi = 100, #fig.path='Figs/',
  cache = T,
  warning = F, 
  message = F
  #, echo=F, 
  )

opts_knit$set(root.dir = "~/Dropbox/TeachingUNL/DataScience/Datasets/Chapter_3_data_wrangling")
# setwd("~/Dropbox/TeachingUNL/DataScience/Datasets/Chapter_3_data_wrangling") 

library(flipbookr)
library(flair)
```

```{r xaringan-themer, include = FALSE, warning = FALSE, eval = F}
library(xaringanthemer)
style_duo_accent(
  header_h1_font_size = "1.3rem",
  header_h2_font_size = "1.0rem",
  header_h3_font_size = "1rem",
  code_inline_font_size = "0.7em",
  code_inline_background_color = "#e6e6e6", 
  text_font_size = "0.7rem",
  code_font_size = "0.6rem",
  link_color = "#ff005a"
)
```

```{r xaringanExtra, echo=FALSE}
library(xaringanExtra)
xaringanExtra::use_xaringan_extra(c("tile_view", "animate_css", "tachyons"))
xaringanExtra::use_tile_view()
xaringanExtra::use_panelset()
```

```{r, include = F}
#--- load packages ---#
suppressMessages(library(data.table))
suppressMessages(library(gt))
suppressMessages(library(tidyverse))
````

```{css, echo = F}
.remark-code {
  display: block;
  overflow-x: auto;
  padding: .3em;
  background: #ffe7e7;
} 

.remark-inline-code {
  padding-top: 0px;
  padding-bottom: 0px;
  background-color: #e6e6e6;
}

.hljs-github .hljs {
  background: #F6F6FF;
}


.left-code {
  width: 38%;
  height: 92%;
  float: left;
}

.right-plot {
  width: 60%;
  float: right;
  padding-left: 1%;
}

.left-plot5 {
  width: 48%;
  height: 92%;
  float: left;
}

.right-plot5 {
  width: 48%;
  float: right;
  padding-left: 1%;
}

.full-code {
  width: 100%;
}

ul li{
  margin: 7px;
  
}

ul, li{
  margin-left: 9px; 
  padding-left: 0px; 
}

ol li{
  margin: 7px;
}

ol, li{
  margin-left: 9px; 
  padding-left: 0px; 
}
```

# Table of contents

1. [Importing and exporting data](#inputoutput)
2. [`data.frame` and `tibble`](#df_tbl)
3. [Data manipulation with `dplyr`: the Basics](#dplyr)
4. [Grouped operations](#grouped)
5. [Extensions](#extensions)
6. [Reshaping data](#reshaping)
7. [Merging datasets](#merging)

---

# Learning objectives

The objectives of this chapter is to learn how to use the `tidyverse` package to 

+ import and export datasets in various formats
+ manipulate data 
+ reshape a dataset
+ merge multiple datasets 

---


```{r countrypops, cache = F, include = F}
Australasia <- c("AU", "NZ")
Melanesia <- c("NC", "PG", "SB", "VU")
Micronesia <- c("FM", "GU", "KI", "MH", "MP", "NR", "PW")
Polynesia <- c("PF", "WS", "TO", "TV")

# Create a gt table based on a preprocessed `countrypops`
countrypops %>%
  dplyr::filter(country_code_2 %in% c(
    Australasia, Melanesia, Micronesia, Polynesia)
  ) %>% #BREAK
  dplyr::filter(year %in% c(1995, 2005, 2015)) %>% #BREAK
  dplyr::mutate(region = case_when(
    country_code_2 %in% Australasia ~ "Australasia",
    country_code_2 %in% Melanesia ~ "Melanesia",
    country_code_2 %in% Micronesia ~ "Micronesia",
    country_code_2 %in% Polynesia ~ "Polynesia",
  )) %>% #BREAK
  tidyr::spread(key = year, value = population) %>% #BREAK
  dplyr::arrange(region, desc(`2015`)) %>% #BREAK
  dplyr::select(-starts_with("country_code")) %>% #BREAK
  gt(
    rowname_col = "country_name",
    groupname_col = "region"
  ) %>% #BREAK
  tab_header(
    title = "Populations of Oceania's Countries in 1995, 2005, and 2015"
  ) %>% #BREAK
  tab_spanner(
    label = "Total Population",
    columns = vars(`1995`, `2005`, `2015`)
  ) %>% #BREAK
  fmt_number(
    columns = vars(`1995`, `2005`, `2015`),
    decimals = 0,
    use_seps = TRUE
  )
```

`r chunk_reveal(
  chunk_name = "countrypops", 
  title = "# countrypops",
  break_type = "user", 
  display_type = "both", 
  left_assign = FALSE,
  width = c(50, 50)
  )
`

---


```{r sza, cache = F, include = F}
sza %>%
  dplyr::filter(latitude == 20) %>%
  dplyr::select(-latitude) %>%
  dplyr::filter(!is.na(sza)) %>%
  tidyr::spread(key = "tst", value = sza) %>% #BREAK
  gt(rowname_col = "month") %>% #BREAK
  fmt_missing(
    columns = TRUE,
    missing_text = ""
  ) %>% #BREAK
  tab_stubhead(label = html("month<br>(20&deg;N)")) %>% #BREAK
  tab_header(title = html("&#x2600; Solar Zenith Angles &#x2600;")) %>% #BREAK
  tab_options(
    column_labels.font.size = "smaller",
    table.font.size = "smaller",
    data_row.padding = px(3)
  )
```

`r chunk_reveal(
  chunk_name = "sza", 
  title = "# sza",
  break_type = "user", 
  display_type = "both", 
  left_assign = FALSE,
  width = c(50, 50)
  )
`


---


```{r gtcars, cache = F, include = F}
gtcars %>%
  dplyr::filter(ctry_origin == "Germany") %>%
  dplyr::group_by(mfr) %>%
  dplyr::top_n(2, msrp) %>%
  dplyr::ungroup() %>%
  dplyr::select(mfr, model, drivetrain, msrp) %>% #BREAK
  gt() %>% #BREAK
  tab_header(title = "Select German Automobiles") %>% #BREAK
  cols_merge(
    columns = vars(mfr, model),
    hide_columns = vars(model)
  ) %>% #BREAK
  text_transform(
    locations = cells_body(columns = vars(drivetrain)),
    fn = function(x) toupper(x)
  ) %>% #BREAK
  fmt_currency(
    columns = vars(msrp),
    currency = "USD",
    decimals = 0
  ) %>% #BREAK
  cols_label(
    mfr = "Car",
    drivetrain = "Drivetrain",
    msrp = "MSRP"
  ) %>% #BREAK
  tab_footnote(
    footnote = "Prices in USD.",
    locations = cells_column_labels(columns = vars(msrp))
  ) %>% #BREAK
  tab_footnote(
    footnote = "AWD = All Wheel Drive, RWD = Rear Wheel Drive.",
    locations = cells_column_labels(columns = vars(drivetrain))
  ) %>% #BREAK
  opt_footnote_marks(marks = "letters")
```

`r chunk_reveal(
  chunk_name = "gtcars", 
  title = "# gtcars",
  break_type = "user", 
  display_type = "both", 
  left_assign = FALSE,
  width = c(50, 50)
  )
`

---


```{r sp500, cache = F, include = F}
# Define the start and end dates for the data range
start_date <- "2010-06-02"
end_date <- "2010-06-15"

# The HTML decimal references for the black
# up- and down-pointing triangles are: #9650 and #9660;
# use an in-line style to apply color
up_arrow <- "<span style=\"color:green\">&#9650;</span>"
down_arrow <- "<span style=\"color:red\">&#9660;</span>"

# Create a gt table based on a preprocessed `sp500`
sp500 %>%
  dplyr::filter(date >= start_date & date <= end_date) %>%
  dplyr::select(-adj_close) %>% #BREAK
  gt() %>% #BREAK
  tab_header(
    title = "S&P 500",
    subtitle = glue::glue("{start_date} to {end_date}")
  ) %>% #BREAK
  fmt_date(
    columns = vars(date),
    date_style = 7
  ) %>% #BREAK
  fmt_currency(
    columns = vars(open, high, low, close),
    currency = "USD"
  ) %>% #BREAK
  fmt_number(
    columns = vars(volume),
    scale_by = 1 / 1E9,
    pattern = "{x}B"
  ) %>% #BREAK
  text_transform(
    locations = cells_body(
      columns = "close",
      rows = close > open),
    fn = function(x) paste(x, up_arrow)
  ) %>% #BREAK
  text_transform(
    locations = cells_body(
      columns = "close",
      rows = close < open),
    fn = function(x) paste(x, down_arrow)
  ) %>% #BREAK 
  cols_label(
    date = "Date", open = "Open", high = "High",
    low = "Low", close = "Close", volume = "Volume"
  )
```

`r chunk_reveal(
  chunk_name = "sp500", 
  title = "# sp500",
  break_type = "user", 
  display_type = "both", 
  left_assign = FALSE,
  width = c(50, 50)
  )
`

---


```{r pizzaplace, cache = F, include = F}
pizzaplace %>%
  dplyr::group_by(type, size) %>%
  dplyr::summarize(
    sold = n(),
    income = sum(price)
  ) %>% #BREAK
  gt(rowname_col = "size") %>% #BREAK
  tab_header(title = "Pizzas Sold in 2015") %>% #BREAK
  fmt_number(
    columns = vars(sold),
    decimals = 0,
    use_seps = TRUE
  ) %>% #BREAK
  fmt_currency(
    columns = vars(income),
    currency = "USD"
  ) %>% #BREAK
  summary_rows(
    groups = TRUE,
    columns = vars(sold),
    fns = list(TOTAL = "sum"),
    formatter = fmt_number,
    decimals = 0,
    use_seps = TRUE
  ) %>% #BREAK
  summary_rows(
    groups = TRUE,
    columns = "income",
    fns = list(TOTAL = "sum"),
    formatter = fmt_currency,
    currency = "USD"
  ) %>% #BREAK
  tab_options(
    summary_row.background.color = "#ACEACE",
    row_group.background.color = "#FFEFDB"
  )
```

`r chunk_reveal(
  chunk_name = "pizzaplace", 
  title = "# pizzaplace",
  break_type = "user", 
  display_type = "both", 
  left_assign = FALSE,
  width = c(50, 50)
  )
`

---


```{r exibble, cache = F, include = F}
exibble %>% #BREAK
  gt(
    rowname_col = "row",
    groupname_col = "group"
  ) %>% #BREAK
  fmt_number(
    columns = vars(num),
    decimals = 2) %>% #BREAK
  fmt_date(
    columns = vars(date),
    date_style = 6
  ) %>% #BREAK
  fmt_time(
    columns = vars(time),
    time_style = 4
  ) %>% #BREAK
  fmt_datetime(
    columns = vars(datetime),
    date_style = 6,
    time_style = 4
  ) %>% #BREAK
  fmt_currency(
    columns = vars(currency),
    currency = "EUR"
  ) %>% #BREAK
  tab_options(
    column_labels.font.size = "small",
    table.font.size = "small",
    row_group.font.size = "small",
    data_row.padding = px(3)
  )

```

`r chunk_reveal(
  chunk_name = "exibble", 
  title = "# exibble",
  break_type = "user", 
  display_type = "both", 
  left_assign = FALSE,
  width = c(50, 50)
  )
`


